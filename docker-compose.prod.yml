version: '3.9'

services:
  # ── PostgreSQL ─────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTGRES_DB:-restrosync}
      POSTGRES_USER:     ${POSTGRES_USER:-restrosync}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-restrosync}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis ──────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ── Backend (NestJS) ───────────────────────────────────────────────────────
  backend:
    image: restrosync-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV:           production
      DATABASE_URL:       postgresql://${POSTGRES_USER:-restrosync}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-restrosync}?schema=public
      REDIS_HOST:         redis
      REDIS_PORT:         6379
      REDIS_PASSWORD:     ${REDIS_PASSWORD}
      JWT_SECRET:         ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      PORT:               3000
    volumes:
      - ./backups:/backups
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/v1/health || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3

  # ── Frontend (React + Nginx) ───────────────────────────────────────────────
  frontend:
    image: restrosync-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ""    # Empty = same origin (nginx proxies /api)
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

  # ── Backup cron ────────────────────────────────────────────────────────────
  backup:
    image: postgres:16-alpine
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./backups:/backups
    entrypoint: |
      /bin/sh -c '
        while true; do
          sleep 86400
          FILENAME="/backups/backup_$$(date +%Y%m%d_%H%M%S).sql.gz"
          pg_dump -h postgres -U ${POSTGRES_USER:-restrosync} ${POSTGRES_DB:-restrosync} | gzip > $$FILENAME
          echo "Backup created: $$FILENAME"
          find /backups -name "*.sql.gz" -mtime +30 -delete
        done
      '

volumes:
  postgres_data:
  redis_data:
